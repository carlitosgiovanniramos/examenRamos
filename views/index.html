<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Estudiantes</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<style>
    table, th, td {
        border: 1px solid black;
        border-collapse: collapse;
    }
</style>
<body>
    <h2>Lista Estudiantes</h2>
    <button id="btnInsert" style="margin-bottom: 10px;">Insertar Estudiantes</button>
    <br>
    <input type="text" id="searchStudent">
    <button id="btnSearch">Filtrar</button>
    <button id="btnResetSearch" style="display: none;">Mostrar Todos</button>
    <hr style="margin-bottom: 30px">
    <button id="btnList" style="margin-bottom: 10px;">Listar Estudiantes</button>
    <button id="btnEdit" style="margin-bottom: 10px;">Editar Estudiante</button>
    <button id="btnDelete" style="margin-bottom: 10px;">Eliminar Estudiante</button>
    <form action="">
        <label for="cedula">Cedula</label>
        <br>
        <input type="text" id="cedula">
        <br>
        <label for="nombre">Nombre</label>
        <br>
        <input type="text" id="nombre">
        <br>
        <label for="apellido">Apellido</label>
        <br>
        <input type="text" id="apellido">
        <br>
        <label for="direccion">Direccion</label>
        <br>
        <input type="text" id="direccion">
        <br>
        <label for="telefono">Telefono</label>
        <br>
        <input type="text" id="telefono">
        <br>
    </form>
    <br>
    <table id="tableStudents" class="tableStudents"></table>

    <script>
        const apiUrl = "http://localhost/examen/controllers/api.php";

        function cleanForm() {
            $('#cedula').val("");
            $('#nombre').val("");
            $("#apellido").val("");
            $("#direccion").val("");
            $("#telefono").val("");
        }

        function renderTable(students) {
            if(students.length === 0) {
                $("#tableStudents").html(`<tr><td>No se encontraron Resultados</td></tr>`);
                return;
            }
                    let htmlTable =`
                    <tr>
                        <th> CEDULA </th>
                        <th> NOMBRE </th>
                        <th> APELLIDO </th>
                        <th> DIRECCION </th>
                        <th> TELEFONO </th> 
                    </tr>`;
                    students.forEach( (student) => {
                        htmlTable += `
                        <tr class="student-row"
                        data-cedula="${student.cedula}"
                        data-nombre="${student.nombre}"
                        data-apellido="${student.apellido}"
                        data-direccion="${student.direccion}"
                        data-telefono="${student.telefono}">
                        <td>${student.cedula}</td>
                        <td>${student.nombre}</td>
                        <td>${student.apellido}</td>
                        <td>${student.direccion}</td>
                        <td>${student.telefono}</td>
                        </tr>`;   
                    });
                    $("#tableStudents").html(htmlTable);
                    
                    $('.student-row').click(function(){
                        $('.student-row').removeClass('seleccion');
                        $(this).addClass('seleccion');

                        $('#cedula').val($(this).data('cedula'));
                        $('#nombre').val($(this).data('nombre'));
                        $('#apellido').val($(this).data('apellido'));
                        $('#direccion').val($(this).data('direccion'));
                        $('#telefono').val($(this).data('telefono'));
                    });
            }

            function loadTable() {
                $.ajax({
                    url: apiUrl,
                    type: 'GET',
                    dataType: 'json',
                    success: (data) => {
                        renderTable(data);
                    },
                    error: function(error) {
                        console.error("Error al obtener el get", error);
                    }
                });
            }

        
        $('#btnList').click(()=> {
            cleanForm();
            loadTable();
        });

        $('#btnInsert').click(()=>{
            $.ajax({
                url: apiUrl,
                type: 'POST',
                // puedes quitar dataType:'json' si la respuesta no siempre es JSON válido
                data: {
                    cedula: $('#cedula').val(),
                    nombre: $('#nombre').val(),
                    apellido: $('#apellido').val(),
                    direccion: $('#direccion').val(),
                    telefono: $('#telefono').val()
                },
                success: function(data) {
                    cleanForm();
                    loadTable();
                    alert("Estudiante insertado correctamente");
                },
                error: function(xhr, status, errorThrown) {
                    console.error("AJAX error:", status, errorThrown);
                    console.error("HTTP status:", xhr.status);
                    console.error("Response text:", xhr.responseText);
                    alert("Error al insertar. Mira la consola y la pestaña Network del navegador.");
                }
            });
        });

        $('#btnEdit').click(()=>{
            $.ajax({
                url: apiUrl,
                type: 'PUT',
                data: {
                    cedula: $('#cedula').val(),
                    nombre: $('#nombre').val(),
                    apellido: $('#apellido').val(),
                    direccion: $('#direccion').val(),
                    telefono: $('#telefono').val()
                },
                success: function(data){
                    cleanForm();
                    loadTable();
                    alert("Estudiante modificado correctamente");               
                },
                error: function(error){
                    console.error("Error al actualizar informacion", error);
                }
            });
        });

        $('#btnDelete').click(()=>{
            $.ajax({
                url: apiUrl + '?cedula=' + $('#cedula').val(),
                type:'DELETE',
                dataType: 'json',
                success: (data)=>{
                    cleanForm();
                    loadTable();
                    alert("Estudiante eliminado correctamente");
                },
                error: (error)=> {
                    console.error("Error al eliminar Estudiante", error);
                }
            });
        });

        $('#btnSearch').click(()=>{
            const cedula = $('#searchStudent').val();
            if(!cedula){
                alert("Porfavor, Ingresa una cedula para buscar");
                return;
            }
            $.ajax({
                url: apiUrl + '?cedula=' + cedula,
                type: 'GET',
                success: function (data) {
                    renderTable(data);
                    $('#btnResetSearch').show();
                },
                error: (xhr)=> {
                    console.error("Error al buscar estudiante", xhr.responseText);
                    $('#tableStudents').html(`<tr><td> Error al buscar revisa la consola</td></tr>`)
                }
            });
        });

        $('#btnResetSearch').click(()=>{
            cleanForm();
            $('#searchStudent').val('');
            loadTable();
            $('#btnResetSearch').hide();
        });
    </script>
    
</body>
</html>